
-- Criação da Tabela de Usuários
-- Armazena dados de login e vínculo familiar (family_id)
CREATE TABLE IF NOT EXISTS users (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT,
    google_id TEXT,
    family_id TEXT, -- Usuários com o mesmo family_id compartilham a visualização
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    settings JSONB DEFAULT '{"includeCreditCardsInTotal": true}'
);

-- Criação da Tabela de Convites
-- Gerencia códigos temporários para unir usuários em famílias
CREATE TABLE IF NOT EXISTS invites (
    id SERIAL PRIMARY KEY,
    code TEXT NOT NULL,
    family_id TEXT NOT NULL,
    created_by TEXT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Criação da Tabela de Contas
-- Carteiras, Bancos, Cartões, Investimentos
CREATE TABLE IF NOT EXISTS accounts (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL, -- WALLET, BANK, CARD, INVESTMENT
    balance DECIMAL(15,2) DEFAULT 0,
    user_id TEXT REFERENCES users(id),
    family_id TEXT, -- Vínculo forte com a Família/Workspace
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    credit_limit DECIMAL(15,2), -- Novo: Limite do Cartão
    closing_day INTEGER,        -- Novo: Dia de Fechamento da Fatura
    due_day INTEGER             -- Novo: Dia de Vencimento da Fatura
);

-- Criação da Tabela de Contatos (Favorecidos / Pagadores)
CREATE TABLE IF NOT EXISTS contacts (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    user_id TEXT REFERENCES users(id),
    family_id TEXT, -- Vínculo forte com a Família/Workspace
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    email TEXT,
    phone TEXT,
    document TEXT,
    pix_key TEXT,
    deleted_at TIMESTAMP
);

-- Criação da Tabela de Categorias
CREATE TABLE IF NOT EXISTS categories (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT, -- INCOME, EXPENSE
    user_id TEXT REFERENCES users(id),
    family_id TEXT, -- Vínculo forte com a Família/Workspace
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- Criação da Tabela de Transações
-- Receitas e Despesas
CREATE TABLE IF NOT EXISTS transactions (
    id TEXT PRIMARY KEY,
    description TEXT NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    type TEXT NOT NULL, -- INCOME, EXPENSE, TRANSFER
    category TEXT NOT NULL,
    date DATE NOT NULL,
    status TEXT NOT NULL, -- PAID, PENDING, OVERDUE
    account_id TEXT REFERENCES accounts(id) ON DELETE CASCADE,
    destination_account_id TEXT REFERENCES accounts(id) ON DELETE SET NULL, -- Coluna para Transferências
    contact_id TEXT REFERENCES contacts(id) ON DELETE SET NULL, -- Vínculo com Contato
    user_id TEXT REFERENCES users(id),
    family_id TEXT, -- Vínculo forte com a Família/Workspace
    is_recurring BOOLEAN DEFAULT FALSE,
    recurrence_frequency TEXT, -- WEEKLY, MONTHLY, YEARLY
    recurrence_end_date DATE,
    interest_rate DECIMAL(10,2) DEFAULT 0, -- Taxa de juros mensal (%)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Criação da Tabela de Metas Financeiras
CREATE TABLE IF NOT EXISTS goals (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    target_amount DECIMAL(15,2) NOT NULL,
    current_amount DECIMAL(15,2) NOT NULL,
    deadline DATE,
    user_id TEXT REFERENCES users(id),
    family_id TEXT, -- Vínculo forte com a Família/Workspace
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Histórico de Notificações
CREATE TABLE IF NOT EXISTS notification_logs (
    id SERIAL PRIMARY KEY,
    user_id TEXT REFERENCES users(id),
    channel TEXT NOT NULL, -- 'EMAIL', 'WHATSAPP'
    recipient TEXT NOT NULL,
    subject TEXT, -- Template name ou Assunto do Email
    content TEXT,
    status TEXT DEFAULT 'SENT',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- MÓDULO SERVIÇOS --

-- Ordens de Serviço
CREATE TABLE IF NOT EXISTS service_orders (
    id TEXT PRIMARY KEY,
    number SERIAL, -- Número sequencial visível
    title TEXT NOT NULL,
    description TEXT,
    contact_id TEXT REFERENCES contacts(id),
    status TEXT NOT NULL, -- OPEN, IN_PROGRESS, DONE, CANCELED
    total_amount DECIMAL(15,2) DEFAULT 0,
    start_date DATE,
    end_date DATE,
    user_id TEXT REFERENCES users(id),
    family_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- Contratos
CREATE TABLE IF NOT EXISTS contracts (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    contact_id TEXT REFERENCES contacts(id),
    value DECIMAL(15,2) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE,
    status TEXT NOT NULL, -- ACTIVE, EXPIRED, CANCELED
    billing_day INTEGER, -- Dia de faturamento
    user_id TEXT REFERENCES users(id),
    family_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- Pedidos de Venda / Compra (Simplificado)
CREATE TABLE IF NOT EXISTS commercial_orders (
    id TEXT PRIMARY KEY,
    type TEXT NOT NULL, -- SALE, PURCHASE
    description TEXT NOT NULL,
    contact_id TEXT REFERENCES contacts(id),
    amount DECIMAL(15,2) NOT NULL,
    date DATE NOT NULL,
    status TEXT NOT NULL, -- DRAFT, CONFIRMED, CANCELED
    transaction_id TEXT, -- Link para transação financeira gerada
    user_id TEXT REFERENCES users(id),
    family_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- Notas Fiscais (Registro)
CREATE TABLE IF NOT EXISTS invoices (
    id TEXT PRIMARY KEY,
    number TEXT,
    series TEXT,
    type TEXT NOT NULL, -- ISS, ICMS
    amount DECIMAL(15,2) NOT NULL,
    issue_date DATE NOT NULL,
    status TEXT NOT NULL, -- ISSUED, CANCELED, ERROR
    contact_id TEXT REFERENCES contacts(id),
    file_url TEXT, -- Link para PDF/XML
    user_id TEXT REFERENCES users(id),
    family_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
